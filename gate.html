<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Gate</title>
    <script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.19.0/firebase-database.js"></script>
   

</head>
<body>
    <p id="datetime">Date/ Time: </p>
    <img id="displayPic" src="https://drive.google.com/uc?id=1DTJn9k77316HcZr61ruuvIXEq6ChXGr1" />
    <form id="testForm" action="#">
        <input type="text" id="test_ultra_value" name="ultraValue" value=0 />
        <input type="submit" value="Submit" />
    </form>
    <button onclick="getTestValue()">Display Value</button>
    <button id="open-btn" onclick="gateActivate(true)">Open</button>
    <button id="open-btn" onclick="gateActivate(false)">Close</button>
    <p id="ultra_value" style="font-size:50px">Distance: </p>

    <script>
        var IOTfirebaseConfig = {
            apiKey: "AIzaSyDqVTZhCodlKPrB7Y2QcSvBhXpMv1H-WCQ",
            authDomain: "bait2123-202010-04.firebaseapp.com",
            databaseURL: "https://bait2123-202010-04.firebaseio.com",
            projectId: "bait2123-202010-04",
            storageBucket: "bait2123-202010-04.appspot.com",
            messagingSenderId: "441104878168",
            appId: "1:441104878168:web:88d5673f47addd348c982d"
        };
        // Initialize Firebase
        firebase.initializeApp(IOTfirebaseConfig);
        firebase.analytics();
        console.log(firebase);
        // Get a reference to the database service
        var database = firebase.database();

        //GET CURRENT DATE TIME 
        var today = new Date();
        var yyyy = today.getFullYear();
        var mm = today.getMonth() + 1;
        var dd = today.getDate();
        var hour = today.getHours();
        if (dd < 10) {
            dd = '0' + dd;
        }
        if (mm < 10) {
            mm = '0' + mm;
        }
        if (hour < 10) {
            hour = '0' + hour;
        }
        console.log(yyyy, mm, dd, hour);
        console.log(today);

        //TIMER
        function startTimer() {
            startTime = new Date();
        };
        function endTimer() {
            //if (x < 100) {
            endTime = new Date();
            var timeDiff = endTime - startTime;
            var seconds = Math.round(timeDiff / 1000);
            console.log(seconds + " seconds");
            timeElapsed(seconds);
            //}
        };
        function timeElapsed(sec) {
            return sec;
        }

        //get ultrasonic value
        /*
        database.ref('/PI_04_' + yyyy + mm + dd + '/' + hour).limitToLast(1).on('value', function (snapshot) {
            snapshot.forEach(function (childSnapshot) {
                var ultra = childSnapshot.val().ultra;
                document.getElementById("datetime").textContent = 'Date/Time: ' + today;
                console.log("Ultrasonic: " + ultra);
                document.getElementById("ultra_value").textContent = 'Distance: ' + ultra + 'cm';

                window.onload = function () {
                    document.onload = function () {
                        function gateImg(x) {
                            var gateOpenPic = "https://drive.google.com/uc?id=1kFm-y5v5hUisjtxHIFta4cSM2KS3Wg1m";
                            var gateClosedPic = "https://drive.google.com/uc?id=1DTJn9k77316HcZr61ruuvIXEq6ChXGr1";
                            if (x < 100) {
                                document.getElementById("displayPic").src = gateOpenPic;
                            } else {
                                document.getElementById("displayPic").src = gateClosedPic;
                            }
                        }

                        //gate control
                        //var time = new TimeCapture();
                        var cardVerification = true;
                        var gateOpen = true;
                        var totalTime = 0;

                        while (cardVerification == true) {                  //if the driver's card is verified
                            gateOpen == true;                               //open the gate
                            //if (ultra < 100) {                              //car detected
                            //time.start();
                            startTimer();
                            while (ultra < 100) {                       //while the car still under the barrier
                                gateImg(ultra);
                                gateOpen == true;
                                console.log("gate still opening");
                                //time.check();
                                endTimer();
                                totalTime += timeElapsed();
                                if (totalTime >= 10) {
                                    //buzzer alarm
                                }
                                if (ultra > 99) {
                                    break;
                                }
                            }

                            //if (ultra > 99) {                           //when the car pass through the barrier / leave
                            totalTime = 0;
                            startTimer();
                            do {
                                endTimer();
                                totalTime += timeElapsed();
                            } while (totalTime < 4);                     // gate close after 3 seconds
                            gateImg(ultra);
                            gateOpen == false;
                            console.log("gate closed")
                            //}
                            //}

                        }
                    }
                }
            });
        });
        */
        /*
        database.ref('/PI_04_' + yyyy + mm + dd + '/' + hour).limitToLast(1).on('value', function (snapshot) {
            snapshot.forEach(function (childSnapshot) {
                var ultra = childSnapshot.val().ultra;
                document.getElementById("datetime").textContent = 'Date/Time: ' + today;
                console.log("Ultrasonic: " + ultra);
                document.getElementById("ultra_value").textContent = 'Distance: ' + ultra + 'cm';


            });
        });
        */
        // window.addEventListener('DOMContentLoaded', (event) => {
        //  window.onload = function () {
        //   document.onload = function () {
        function getTestValue() {
            //var ultra = document.getElementById("test_ultra_value").value;
            var getultra = document.getElementById("testForm").elements.namedItem("ultraValue").value;
            console.log("Test value : " + getultra);
            document.getElementById("ultra_value").textContent = "Distance : " + getultra;
            return getultra;
        }
        // test save
        function gateImg(x) {
            var gateOpenPic = "https://drive.google.com/uc?id=1kFm-y5v5hUisjtxHIFta4cSM2KS3Wg1m";
            var gateClosedPic = "https://drive.google.com/uc?id=1DTJn9k77316HcZr61ruuvIXEq6ChXGr1";
            if (x < 100) {
                document.getElementById("displayPic").src = gateOpenPic;
            } else {
                document.getElementById("displayPic").src = gateClosedPic;
            }
        }

        function promptInput() {
            var input = prompt("Next value: ", "0");
        }

        function updateFirebaseControl(input) {
            if (input == 1) {
                var data = {
                    led: "1",
                    lcd: "1",
                    lcdtxt: "= GATE OPENING ="
                }
                database.ref('PI_04_CONTROL').update(data);
            } else if (input == 0) {
                var data = {
                    led: "1",
                    lcd: "1",
                    lcdtxt: "= GATE  CLOSED ="
                }
                database.ref('PI_04_CONTROL').update(data);
            }
        }

        function gateActivate(x) {
            var ultra = getTestValue();
            //var ultra = document.getElementById("ultra_value").value;
            console.log("Ultra : " + ultra);
            var gateActivation = x;
            var gateOpen = true;
            var totalTime = 0;
            var promptInput = 0;

            if (gateActivate == true) {                         // WHEN GATE OPEN BTN IS PRESSED
                while (gateActivation == true) {                  
                    // GATE OPEN
                    gateOpen == true;
                    alert("Gate Open");
                    updateFirebaseControl(1);
                    startTimer();
                    gateImg(ultra);
                    while (ultra < 100) {                       //WHEN THE CAR STILL UNDER THE BARRIER / HAVENT LEAVE YET
                        gateOpen == true;
                        console.log("gate still opening");
                        endTimer();
                        totalTime += timeElapsed();
                        if (totalTime >= 15) {
                            var openBuzzer = {                  //BUZZER ALARM
                                buzzer: '1',
                                relay: '1'                     //TURN ON RED LED
                            }
                            database.ref('PI_04_CONTROL').update(openBuzzer);
                            alert("Car still under the barrier");
                        }
                        if (ultra > 99) {
                            break;
                        }
                        promptInput = prompt("Next value", 0);
                        ultra = promptInput;
                    }

                    // GATE CLOSE / CAR LEAVE
                    //if (ultra > 99) {
                    totalTime = 0;
                    startTimer();
                    do {
                        endTimer();
                        totalTime += timeElapsed();
                    } while (totalTime < 4);                     // GATE CLOSE AFTER 3 SECONDS
                    gateImg(ultra);
                    alert("Gate Closed");
                    gateOpen == false;
                    console.log("gate closed");
                    updateFirebaseControl(0);
                    break;

                }
            } else {                                        // WHEN GATE CLOSE BTN IS PRESSED
                while (ultra < 100) {                      // IF CAR / OTHER OBSTACLE DETECTED UNDER THE BARRIER, GATE REMAIN OPEN UNTIL IT LEAVE
                    alert("OBSTACLE DETECTED!");
                    gateOpen == true;
                    gateImg(ultra);
                    updateFirebaseControl(1);
                    if (ultra > 99) {
                        break;
                    }
                }
                gateOpen == false;
                gateImg(ultra);
                alert("Gate Closed");
                updateFirebaseControl(0);
            }
        }
    </script>
</body>
</html>